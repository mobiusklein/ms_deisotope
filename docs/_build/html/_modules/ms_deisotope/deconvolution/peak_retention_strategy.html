
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ms_deisotope.deconvolution.peak_retention_strategy &#8212; ms_deisotope  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/haiku.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
      <div class="header" role="banner"><img class="rightlogo" src="../../../_static/logo.svg" alt="Logo"/><h1 class="heading"><a href="../../../index.html">
          <span>ms_deisotope  documentation</span></a></h1>
        <h2 class="heading"><span>ms_deisotope.deconvolution.peak_retention_strategy</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for ms_deisotope.deconvolution.peak_retention_strategy</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;A set of strategies for retaining peaks following deconvolution to</span>
<span class="sd">recover from low quality spectra. These methods are not recommended for</span>
<span class="sd">use on spectra where most ions are multiply charged.</span>

<span class="sd">These objects are meant to be provided to :func:`~.deconvolut_peaks`&#39;s</span>
<span class="sd">`retention_strategy` argument, which will take care of calling them with</span>
<span class="sd">the appropriate arguments.</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">abc</span>

<span class="kn">from</span> <span class="nn">six</span> <span class="kn">import</span> <span class="n">add_metaclass</span>

<span class="kn">from</span> <span class="nn">ms_deisotope.averagine</span> <span class="kn">import</span> <span class="n">neutral_mass</span>

<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">from_fitted_peak</span>

<span class="n">intensity_getter</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s2">&quot;intensity&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="PeakRetentionStrategyBase"><a class="viewcode-back" href="../../../deconvolution/deconvolution.html#ms_deisotope.deconvolution.peak_retention_strategy.PeakRetentionStrategyBase">[docs]</a><span class="nd">@add_metaclass</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">PeakRetentionStrategyBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A strategy for retaining peaks left behind by the deconvolution procedure.</span>

<span class="sd">    Deconvolution requires that the isotopic peak structure is present in the peak list,</span>
<span class="sd">    which may not be consistent for all types of data. This type of method is appropriate</span>
<span class="sd">    when the caller expects real peaks may have been left behind, as is the case with smaller</span>
<span class="sd">    peptides and lower quality tandem mass spectra.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PeakRetentionStrategyBase.create_peak"><a class="viewcode-back" href="../../../deconvolution/deconvolution.html#ms_deisotope.deconvolution.peak_retention_strategy.PeakRetentionStrategyBase.create_peak">[docs]</a>    <span class="k">def</span> <span class="nf">create_peak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fitted_peak</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a :class:`~.DeconvolutedPeak` from a given :class:`~.FittedPeak` ``peak``</span>
<span class="sd">        and an optional charge state.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fitted_peak : :class:`~.FittedPeak`</span>
<span class="sd">            The peak to treat as the monoisotopic peak of the unfitted deconvoluted peak</span>
<span class="sd">        charge : int, optional</span>
<span class="sd">            The charge state to specify the peak at (the default is 1)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DeconvolutedPeak</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">from_fitted_peak</span><span class="p">(</span><span class="n">fitted_peak</span><span class="p">,</span> <span class="n">charge</span><span class="p">)</span></div>

<div class="viewcode-block" id="PeakRetentionStrategyBase.retain_peaks"><a class="viewcode-back" href="../../../deconvolution/deconvolution.html#ms_deisotope.deconvolution.peak_retention_strategy.PeakRetentionStrategyBase.retain_peaks">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">retain_peaks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peaklist</span><span class="p">,</span> <span class="n">original_peaklist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">charge_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">solutions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given a list of :class:`~.FittedPeak` objects left over after deconvolution,</span>
<span class="sd">        produce a list of :class:`~.DeconvolutedPeak` objects from them according to some</span>
<span class="sd">        criteria.</span>

<span class="sd">        Deconvolution requires that the isotopic peak structure is present in the peak list,</span>
<span class="sd">        which may not be consistent for all types of data. This type of method is appropriate</span>
<span class="sd">        when the caller expects real peaks may have been left behind, as is the case with smaller</span>
<span class="sd">        peptides and lower quality tandem mass spectra.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        peaklist : :class:`~.PeakSet`</span>
<span class="sd">            The list of peaks that remain after deconvolution</span>
<span class="sd">        original_peaklist : :class:`~.PeakSet`, optional</span>
<span class="sd">            The list of peaks that were initially presented for deconvolution,</span>
<span class="sd">            which may be used to infer relative thresholds from. If not provided,</span>
<span class="sd">            these thresholds may be learned from the left over peaks, but the</span>
<span class="sd">            parameters may not be as good.</span>
<span class="sd">        charge_range : :class:`tuple`, optional</span>
<span class="sd">            The range of charge states considered during deconvolution. Used to infer</span>
<span class="sd">            the minimum charge state to assign to the peaks this method creates. If</span>
<span class="sd">            not provided, the default charge state is :const`1`.</span>
<span class="sd">        solutions: :class:`~.DeconvolutedPeakSet`, optional</span>
<span class="sd">            The accepted solutions which might be used to infer/reject additional peaks.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`list`:</span>
<span class="sd">            The list of :class:`~.DeconvolutedPeak` objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="PeakRetentionStrategyBase.__call__"><a class="viewcode-back" href="../../../deconvolution/deconvolution.html#ms_deisotope.deconvolution.peak_retention_strategy.PeakRetentionStrategyBase.__call__">[docs]</a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peaklist</span><span class="p">,</span> <span class="n">original_peaklist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">charge_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">solutions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A wrapper for :meth:`retain_peaks`. Given a list of :class:`~.FittedPeak`</span>
<span class="sd">        objects left over after deconvolution, produce a list of :class:`~.DeconvolutedPeak`</span>
<span class="sd">        objects from them according to some criteria.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        peaklist : :class:`~.PeakSet`</span>
<span class="sd">            The list of peaks that remain after deconvolution</span>
<span class="sd">        original_peaklist : :class:`~.PeakSet`, optional</span>
<span class="sd">            The list of peaks that were initially presented for deconvolution,</span>
<span class="sd">            which may be used to infer relative thresholds from. If not provided,</span>
<span class="sd">            these thresholds may be learned from the left over peaks, but the</span>
<span class="sd">            parameters may not be as good.</span>
<span class="sd">        charge_range : :class:`tuple`, optional</span>
<span class="sd">            The range of charge states considered during deconvolution. Used to infer</span>
<span class="sd">            the minimum charge state to assign to the peaks this method creates. If</span>
<span class="sd">            not provided, the default charge state is :const`1`.</span>
<span class="sd">        solutions: :class:`~.DeconvolutedPeakSet`, optional</span>
<span class="sd">            The accepted solutions which might be used to infer/reject additional peaks.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`list`:</span>
<span class="sd">            The list of :class:`~.DeconvolutedPeak` objects.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :meth:`retain_peaks`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">retain_peaks</span><span class="p">(</span><span class="n">peaklist</span><span class="p">,</span> <span class="n">original_peaklist</span><span class="p">,</span> <span class="n">charge_range</span><span class="p">)</span></div>

<div class="viewcode-block" id="PeakRetentionStrategyBase.infer_minimum_charge"><a class="viewcode-back" href="../../../deconvolution/deconvolution.html#ms_deisotope.deconvolution.peak_retention_strategy.PeakRetentionStrategyBase.infer_minimum_charge">[docs]</a>    <span class="k">def</span> <span class="nf">infer_minimum_charge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charge_range</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given a charge range :class:`tuple`, return the smallest absolute magnitude</span>
<span class="sd">        charge state possible in that range.</span>

<span class="sd">        This method is polarity aware, and does its reasoning on the absolute magnitude</span>
<span class="sd">        of the charge state range, rather than on its signed value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        charge_range : :class:`tuple`</span>
<span class="sd">            The range of charge values that were used during the deconvolution process</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`int`:</span>
<span class="sd">            The minimum charge state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">charge_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="n">abs_range</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">charge_range</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">abs_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">abs_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">min_charge</span> <span class="o">=</span> <span class="n">charge_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">min_charge</span> <span class="o">=</span> <span class="n">charge_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">min_charge</span></div></div>


<div class="viewcode-block" id="TopNRetentionStrategy"><a class="viewcode-back" href="../../../deconvolution/deconvolution.html#ms_deisotope.deconvolution.peak_retention_strategy.TopNRetentionStrategy">[docs]</a><span class="k">class</span> <span class="nc">TopNRetentionStrategy</span><span class="p">(</span><span class="n">PeakRetentionStrategyBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This strategy retains up to at most :attr:`n_peaks` peaks from the</span>
<span class="sd">    leftover signal, and requires that any peaks it retains are atleast</span>
<span class="sd">    :attr:`base_peak_coefficient` * the base peak of the original peak list.</span>

<span class="sd">    This strategy treats the leftover peak as if it were the monoisotopic peak</span>
<span class="sd">    of an unobserved isotopic distribution. Because the monoisotopic peak ceases</span>
<span class="sd">    to dominate an isotopic distribution above a certain mass (as implied by an</span>
<span class="sd">    averagine isotopic model), any peak selected must have a neutral mass below</span>
<span class="sd">    :attr:`max_mass`.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    n_peaks : int</span>
<span class="sd">        The maximum number of peaks to retain.</span>
<span class="sd">    base_peak_coefficient : float</span>
<span class="sd">        The fraction of the base peak intensity to threshold on. Defaults to :const:`0.05`</span>
<span class="sd">    max_mass : float</span>
<span class="sd">        The largest neutral mass that a peak may have before it would no longer have a dominant</span>
<span class="sd">        monoisotopic peak and the peak will be discarded.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_peaks</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">base_peak_coefficient</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">max_mass</span><span class="o">=</span><span class="mf">850.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_peaks</span> <span class="o">=</span> <span class="n">n_peaks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_peak_coefficient</span> <span class="o">=</span> <span class="n">base_peak_coefficient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_mass</span> <span class="o">=</span> <span class="n">max_mass</span>

<div class="viewcode-block" id="TopNRetentionStrategy.retain_peaks"><a class="viewcode-back" href="../../../deconvolution/deconvolution.html#ms_deisotope.deconvolution.peak_retention_strategy.TopNRetentionStrategy.retain_peaks">[docs]</a>    <span class="k">def</span> <span class="nf">retain_peaks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peaklist</span><span class="p">,</span> <span class="n">original_peaklist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">charge_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">solutions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">original_peaklist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base_peak_sequence</span> <span class="o">=</span> <span class="n">peaklist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_peak_sequence</span> <span class="o">=</span> <span class="n">original_peaklist</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">base_peak</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">peak</span><span class="o">.</span><span class="n">intensity</span> <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">base_peak_sequence</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">min_charge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infer_minimum_charge</span><span class="p">(</span><span class="n">charge_range</span><span class="p">)</span>
        <span class="n">min_charge</span> <span class="o">/=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">min_charge</span><span class="p">)</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_peak_coefficient</span> <span class="o">*</span> <span class="n">base_peak</span>
        <span class="n">peaklist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">peaklist</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">intensity_getter</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peaklist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">neutral_mass</span><span class="p">(</span><span class="n">peak</span><span class="o">.</span><span class="n">mz</span><span class="p">,</span> <span class="n">min_charge</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_mass</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">peak</span><span class="o">.</span><span class="n">intensity</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create_peak</span><span class="p">(</span><span class="n">peak</span><span class="p">,</span> <span class="n">min_charge</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_peaks</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">result</span></div></div>


<span class="n">simple_peak_retention</span> <span class="o">=</span> <span class="n">TopNRetentionStrategy</span><span class="p">()</span>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Joshua Klein.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.2.0.
    </div>
  </body>
</html>